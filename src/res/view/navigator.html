<script>
  var pl = [
            @model({'path':'@^element.getAttribute*(MediaPath)*@', 'title':'@~element.getAttribute*(Title)*@'},)@
            ];
  function focusSong(tr) {
		tr.style.backgroundColor = '#def';
		var cdiv = getPlayCtrlDiv(tr);
		cdiv.style.display = '';
  }
  function meanSong(tr) {
		tr.style.backgroundColor = '#DDE';
		var cdiv = getPlayCtrlDiv(tr);
		cdiv.style.display = 'none';
  }
</script>
@%'insert/playctrl.html'@
@%'insert/directories.html'@
<table style="width:900px;margin:auto;background-color:#DDE">
  <tr>
    <th>@label.track@</th>
    <th>@label.song@</th>
    <th>@label.artist@</th>
    <th>@label.album@</th>
    <th>@label.year@</th>
    <th>@label.genre@</th>
    <th>@label.length@</th>
    <th>@label.samplerate@</th>
 </tr>
 @model(
    <tr onmouseover="focusSong(this)" onmouseout="meanSong(this)">
       <td id="track_@index@">@element.getAttribute*(Track)*@</td>
       <td>
         <div>@element.getAttribute*(Title)*@</div>
         <div id="play_btn" style="display:none;position:relative;left:0"><a href="javascript:void(0)" onclick="playI(@index@)">
           <img src="../image/play_btn.png" alt="@label.play@" border="0"></a>&nbsp;
           <a href="javascript:void(0)" onclick="addToPlay('@^element.getAttribute*(MediaPath)*@')">
           <img src="../image/add_playlist_btn.png" alt="@label.add_play@" border="0"></a>
         </div>
       </td>
       <td>@element.getAttribute*(Artist)*@</td>
       <td>@element.getAttribute*(Album)*@</td>
       <td>@element.getAttribute*(Year)*@</td>
       <td>@element.getAttribute*(Genre)*@</td>
       <td>@element.getAttribute*(Length)*@</td>
       <td>@element.getAttribute*(Samplerate)*@</td>
    </tr>
 )@
</table>
<div id="player">
</div>
<script src="@contextpath@/js/ui.js" language="Javascript"></script>
<script>   
	function initFields() {
		try {
			var MediaControls = Windows.Media.MediaControl;

			// Add event listeners for the buttons
			MediaControls.addEventListener('playpressed', resumePlay, false);
			MediaControls.addEventListener('pausepressed', pausePlay, false);
			MediaControls.addEventListener('playpausetogglepressed',
					togglePlay, false);
		} catch (e) {
		}		
		handlerUrl = 'Navigator/ajax/Asyncupdate';
		// run it async
		window.onunload = releaseUI;
		updateUI();
		updateDirectories();
	}
	
	function notifyUnload() {
		
	}
	function getPlayCtrlDiv(tr) {
		for ( var i = 0; i < tr.cells.length; i++) {
			//var d = tr.cells[i].firstChild;
			//if (d && d.id == 'play_btn')
			//	return d;
			for (var j=0; j<tr.cells[i].childNodes.length; j++)
				if (tr.cells[i].childNodes[j].id == 'play_btn')
					return tr.cells[i].childNodes[j];
		}
		return null;
	}
</script>
<script>
   var cp = -1;
   var prevTitle = '@label.title@';
   var tk;
	function play(p) {
		top.document.title='@label.playing@ ' + p;
		makeGenericAjaxCall('Player', 'playPath=' + encodeURIComponent(p),
				true, function(res) {

				}, function(err) {

				});
	}
	
	function playI(i) {
		var pi = pl[i];
		if (!pi) {
			cp = -1;
			return;
		}
		cp = i;
		makeJSONAjaxCall('Player', 'cmd=3', true, function(res) {
			if(res.error == 'playing') {
				cp--;
				nextPlay();
				return;
			}
			playE(pi);
		}, function(err) {

		});
	}
	
	function playE(pi) {
		top.document.title='@label.playing@ ' + pi.title;
		makeGenericAjaxCall('Player', 'playPath=' + encodeURIComponent(pi.path),
				true, function(res) {
					tk = getElement('track_'+cp);
					if (tk)
						tk.className = 'play_progress';
				}, function(err) {

				});		
	}

	function songFinished(m) {
		//alert('done');
		top.document.title='@label.title@ '+m;
		if (tk)
			tk.className = '';
		if (cp >= 0) {
			var pm = getPlayMode();
			if (pm == 1) {
				if (cp > pl.length - 2)
					cp = -1;
			} else if (pm == 2)
				cp=Math.floor(Math.random()*pl.length) - 1;
 		    playI(cp+1);
		}
	}
	
	function addToPlay(p) {
		makeGenericAjaxCall('Player/ajax/addItem', 'playPath=' + encodeURIComponent(p),
				true, function(res) {

				}, function(err) {

				});
	}
	
	function pausePlay() { 
		prevTitle = top.document.title;
		top.document.title = '@label.paused@';
		playControl(2);
		MediaControls.isPlaying = false;
	}
	
	function resumePlay() {
		top.document.title = prevTitle;
		playControl(1);
		MediaControls.isPlaying = true;
	}
	
	function nextPlay() { 
		playControl(0);
	}
	
	function stopPlay() { 
		cp = -1;
		playControl(0);
	}
	
	function togglePlay() {
		if (MediaControls.isPlaying)
			pausePlay();
		else
			resumePlay();
	}
</script>